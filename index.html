<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Horas Nocturnas — 2025 (Solo lectura)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Rubik:wght@500;700&display=swap" rel="stylesheet">
  <style>
    body {margin:0; font-family:Inter, sans-serif; background:#071534; color:#f1f6ff;}
    .container{max-width:1200px; margin:36px auto; padding:0 20px;}
    .topbar{display:flex; gap:14px; align-items:center;}
    .logo-wrap{width:68px;height:68px;display:grid;place-items:center;background:#fff;border-radius:16px}
    .logo-wrap img{width:56px;height:56px;object-fit:contain}
    .brand h1{margin:0;font-weight:800;font-size:28px}
    .brand .sub{color:#8ea2bd;font-size:13px;margin-top:4px}
    .chips{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .chip{background:#0f2347;border:1px solid #123058;padding:6px 10px;border-radius:999px;font-size:12px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin:18px 0}
    .select,.btn,.search{background:#0f2347;border:1px solid #123058;border-radius:12px;padding:10px 12px;color:#f1f6ff}
    select{appearance:none;background:transparent;color:inherit;border:0;font-size:14px}
    .btn{cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:18px}
    .card{background:#0e1c3b;border:1px solid #123058;border-radius:18px;box-shadow:0 10px 35px rgba(0,0,0,.45)}
    .card .title{padding:18px;color:#8ea2bd;font-size:12px;text-transform:uppercase}
    .table{padding:12px}
    .thead,.row{display:grid;grid-template-columns:50px 1.5fr 2.5fr 160px 120px;gap:8px;padding:10px;border-bottom:1px solid #123058}
    .thead{color:#8ea2bd;font-size:12px;text-transform:uppercase}
    .rank{color:#a9b9d3}
    .bar{height:10px;background:#0a1d3a;border:1px solid #123058;border-radius:999px;position:relative;overflow:hidden}
    .bar>i{position:absolute;inset:0 100% 0 0;background:linear-gradient(90deg,#c51d7a,#0072ce,#00a3e0)}
    .stat{padding:18px}
    .stat h4{margin:0 0 8px;color:#8ea2bd;font-size:12px;text-transform:uppercase}
    .stat .value{font-size:28px;font-weight:800}
    .footer{padding:12px 18px;color:#8ea2bd;font-size:12px}
    .grid-months{display:grid;grid-template-columns:repeat(4,minmax(240px,1fr));gap:16px}
    .row-card{display:grid;grid-template-columns:28px 1fr 80px;gap:10px;padding:8px;border-bottom:1px solid #123058}
    .pos{width:28px;height:28px;display:grid;place-items:center;border-radius:50%;font-weight:800}
    .pos-1{background:gold;color:#000}.pos-2{background:silver;color:#000}.pos-3{background:#cd7f32;color:#000}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="logo-wrap"><img src="logo.png" alt="logo"></div>
    <div class="brand">
      <h1>Horas Nocturnas — 2025</h1>
      <div class="sub">Carga automática desde <code>todo.csv</code></div>
      <div class="chips">
        <span class="chip">22:00 → 08:00</span>
        <span class="chip">Turno fijo 8h</span>
        <span class="chip">:01 → 00</span>
        <span class="chip">Sin letras</span>
      </div>
    </div>
  </div>
  <div class="controls">
    <div class="select"><select id="monthSelect"></select></div>
    <button id="toggleAll" class="btn">Todo 2025</button>
    <div class="search"><input id="searchInput" placeholder="Buscar empleado…"></div>
    <button class="btn" id="toggleCard">Ranking tarjeta</button>
  </div>
  <div id="viewTable">
    <div class="grid">
      <section class="card">
        <div class="title">Distribución por empleado</div>
        <div class="table">
          <div class="thead"><div>#</div><div>Empleado</div><div>Distribución</div><div>Horas Nocturnas</div><div>%</div></div>
          <div id="rows"></div>
        </div>
        <div class="footer" id="footerNote"></div>
      </section>
      <aside class="right">
        <div class="card stat"><h4>Total empleados</h4><div class="value" id="statCount">–</div></div>
        <div class="card stat"><h4>Promedio</h4><div class="value" id="statAvg">–</div></div>
        <div class="card stat"><h4>Máximo</h4><div class="value" id="statMax">–</div></div>
        <div class="card stat"><h4>Mínimo</h4><div class="value" id="statMin">–</div></div>
      </aside>
    </div>
  </div>
  <div id="viewCards" style="display:none">
    <section class="card"><div class="note" id="cardsNote">Top 3</div></section>
    <div id="cardsGrid" class="grid-months"></div>
  </div>
</div>

<script>
(function(){
  const MIN=60,SHIFT=8*MIN,N1_START=22*MIN,N1_END=24*MIN,N2_START=24*MIN,N2_END=32*MIN;
  const monthNames=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const monthDays=[31,28,31,30,31,30,31,31,30,31,30,31], EXPECTED_DAYS=365;
  let RAW=null,EMP=[],MONTH_RANGES=[],ALL_RANGE={start:1,end:1},currentRange=null,sortBy='hours',searchTerm='',viewMode='table';

  const elRows=document.getElementById('rows'),elMonth=document.getElementById('monthSelect'),elToggleAll=document.getElementById('toggleAll');
  const elSortH=document.createElement('div');const elSortP=document.createElement('div');
  const elSearch=document.getElementById('searchInput'),elCount=document.getElementById('statCount'),elAvg=document.getElementById('statAvg'),elMax=document.getElementById('statMax'),elMin=document.getElementById('statMin'),elFooter=document.getElementById('footerNote');
  const elToggleCard=document.getElementById('toggleCard'),elViewTable=document.getElementById('viewTable'),elViewCards=document.getElementById('viewCards'),elCardsGrid=document.getElementById('cardsGrid'),elCardsNote=document.getElementById('cardsNote');

  elToggleAll.addEventListener('click',()=>{if(!RAW)return;elToggleAll.classList.toggle('toggled');const all=elToggleAll.classList.contains('toggled');elMonth.disabled=all;currentRange=all?ALL_RANGE:MONTH_RANGES[0];render();renderCards();});
  elMonth.addEventListener('change',()=>{const idx=+elMonth.value;currentRange=MONTH_RANGES[idx];if(elToggleAll.classList.contains('toggled'))elToggleAll.classList.remove('toggled');render();renderCards();});
  elToggleCard.addEventListener('click',()=>{viewMode=viewMode==='table'?'cards':'table';elToggleCard.textContent=viewMode==='cards'?'Volver a tabla':'Ranking tarjeta';elViewTable.style.display=viewMode==='table'?'':'none';elViewCards.style.display=viewMode==='cards'?'':'none';if(viewMode==='cards')renderCards();});
  elSearch.addEventListener('input',e=>{searchTerm=(e.target.value||'').toLowerCase();render();renderCards();});

  function isHHMM(s){if(!s)return false;const t=String(s).trim();const p=t.split(':');if(p.length!==2)return false;const h=+p[0],m=+p[1];return Number.isInteger(h)&&Number.isInteger(m)&&p[1].length===2&&h>=0&&h<24&&m>=0&&m<60;}
  function roundDownStrict(hhmm){if(!isHHMM(hhmm))return null;const s=String(hhmm).trim();return s.endsWith(':01')?s.slice(0,3)+'00':s;}
  function parseStartToMinutes(hhmm){const t=roundDownStrict(hhmm);if(!t)return null;const[h,m]=t.split(':').map(Number);let mins=h*MIN+m;if(h<8)mins+=24*MIN;return mins;}
  function overlap(aS,aE,bS,bE){const s=Math.max(aS,bS),e=Math.min(aE,bE);return Math.max(0,e-s);}
  function nightHoursFromStart(hhmm){const s=parseStartToMinutes(hhmm);if(s==null)return 0;const e=s+SHIFT;return (overlap(s,e,N1_START,N1_END)+overlap(s,e,N2_START,N2_END))/MIN;}
  function hasLetters(s){return /[a-zA-Z]/.test(s);}
  function nightHoursFromCell(cell){if(!cell||hasLetters(cell))return 0;return nightHoursFromStart(cell);}
  function computeForRange(range){const start=range.start-1,end=range.end-1;return EMP.map(e=>{let total=0;for(let i=start;i<end;i++){const cell=(e.values[i]||'').trim();total+=nightHoursFromCell(cell);}return {name:e.name,hours:total};});}
  function n0(x){return Number(Math.round(x)).toLocaleString('es-AR');}
  function escapeHtml(s){return String(s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',\"'\":'&#39;'}[c]));}

  function hydrateFromCSV(rows){
    if(!rows||rows.length<2){elRows.innerHTML='<div>No se pudo leer todo.csv</div>';return;}
    const nameCol=0,dataStartCol=1;
    EMP=rows.slice(1).map(r=>({name:(r[nameCol]||'').trim(),values:r.slice(dataStartCol)})).filter(e=>e.name&&e.name.toLowerCase()!=='total'&&e.name.toLowerCase()!=='ezeiza');
    for(let i=0;i<EMP.length;i++){const v=EMP[i].values.slice();if(v.length<EXPECTED_DAYS)v.push(...Array(EXPECTED_DAYS-v.length).fill(''));if(v.length>EXPECTED_DAYS)v.length=EXPECTED_DAYS;EMP[i].values=v;}
    MONTH_RANGES=[];let used=0;for(let i=0;i<12;i++){const d=monthDays[i];const start=dataStartCol+used;const end=start+d;MONTH_RANGES.push({key:i,label:monthNames[i]+' 2025',start,end});used+=d;}
    ALL_RANGE={start:MONTH_RANGES[0].start,end:MONTH_RANGES[11].end};
    elMonth.innerHTML=MONTH_RANGES.map((m,i)=>`<option value="${i}">${m.label}</option>`).join('');elMonth.disabled=false;elToggleAll.classList.add('toggled');currentRange=ALL_RANGE;
    render();renderCards();
  }

  function render(){
    if(!RAW){elRows.innerHTML='<div>No se pudo cargar datos</div>';return;}
    const data=computeForRange(currentRange).filter(r=>r.name.toLowerCase().includes(searchTerm));
    const withInt=data.map(r=>({name:r.name,hours:Math.round(r.hours)}));
    const total=withInt.reduce((a,b)=>a+b.hours,0);const max=withInt.reduce((m,r)=>Math.max(m,r.hours),0);
    const enriched=withInt.map(r=>({name:r.name,hours:r.hours,percent:total>0?(r.hours/total*100):0,bar:max>0?(r.hours/max*100):0}));
    const sorted=enriched.sort((a,b)=>sortBy==='percent'?b.percent-a.percent:b.hours-a.hours);
    elRows.innerHTML=sorted.map((r,i)=>`<div class="row"><div class="rank">${i+1}</div><div class="name">${escapeHtml(r.name)}</div><div class="bar"><i style="inset:0 ${(100-r.bar).toFixed(2)}% 0 0"></i></div><div>${n0(r.hours)}</div><div>${r.percent.toFixed(1)}%</div></div>`).join('');
    elCount.textContent=withInt.length;elAvg.textContent=n0(withInt.length?total/withInt.length:0);elMax.textContent=n0(max);elMin.textContent=n0(withInt.length?sorted[sorted.length-1].hours:0);
    elFooter.innerHTML=`Total empleados: ${withInt.length} · Total horas: <strong>${n0(total)}</strong>`;
  }

  function computeTop3ForMonthIndex(mi){const r=MONTH_RANGES[mi];return computeForRange(r).map(e=>({name:e.name,hours:Math.round(e.hours)})).sort((a,b)=>b.hours-a.hours).slice(0,3);}
  function renderCards(){if(!RAW)return;const isAll=(currentRange.start===ALL_RANGE.start&&currentRange.end===ALL_RANGE.end);elCardsGrid.innerHTML='';if(isAll){elCardsGrid.innerHTML=MONTH_RANGES.map((m,i)=>{const top=computeTop3ForMonthIndex(i);const rows=top.map((r,idx)=>`<div class="row-card"><div class="pos pos-${idx+1}">${idx+1}</div><div class="name-ellipsis">${escapeHtml(r.name)}</div><div class="hours">${r.hours}</div></div>`).join('');return `<div class="card"><div class="head"><h3>${m.label}</h3></div><div class="list">${rows}</div></div>`;}).join('');}else{const mi=MONTH_RANGES.findIndex(m=>m.start===currentRange.start&&m.end===currentRange.end);const top=computeTop3ForMonthIndex(mi);elCardsGrid.innerHTML=top.map((r,idx)=>`<div class="row-card"><div class="pos pos-${idx+1}">${idx+1}</div><div class="name-ellipsis">${escapeHtml(r.name)}</div><div class="hours">${r.hours}</div></div>`).join('');}}
  
  // AUTOLOAD CSV
  fetch('todo.csv').then(r=>r.text()).then(t=>{RAW=parseCSV(t);hydrateFromCSV(RAW);}).catch(()=>{elRows.innerHTML='<div>No se encontró todo.csv</div>';});

  function parseCSV(text){const rows=[];let i=0,f='',r=[],q=false;const pushF=()=>{r.push(f);f='';},pushR=()=>{rows.push(r);r=[];};while(i<text.length){const c=text[i];if(q){if(c=='\"'&&text[i+1]=='\"'){f+='\"';i+=2;continue;}if(c=='\"'){q=false;i++;continue;}f+=c;i++;continue;}if(c=='\"'){q=true;i++;continue;}if(c==','){pushF();i++;continue;}if(c=='\\n'){pushF();pushR();i++;continue;}if(c=='\\r'){i++;continue;}f+=c;i++;}if(f!==''||r.length){pushF();pushR();}return rows;}
})();
</script>
</body>
</html>
